<!DOCTYPE html>
<html>
  <head>
    <title>Centrifugo é›†ç¾¤æµ‹è¯•å®¢æˆ·ç«¯</title>
    <script src="https://unpkg.com/centrifuge@5.4.0/dist/centrifuge.js"></script>
    <script src="https://unpkg.com/jsrsasign@10/lib/jsrsasign.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .message {
        background-color: #f8f9fa;
        padding: 10px;
        margin: 5px 0;
        border-left: 3px solid #007bff;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        border-radius: 3px;
      }
      button:hover {
        background-color: #0056b3;
      }
      input[type="text"] {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        width: 200px;
      }
      #messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Centrifugo é›†ç¾¤æµ‹è¯•å®¢æˆ·ç«¯</h1>

    <div id="status" class="status disconnected">æœªè¿æ¥</div>

    <div>
      <h3>è¿æ¥è®¾ç½®</h3>
      <label>æœåŠ¡å™¨åœ°å€: </label>
      <input
        type="text"
        id="serverUrl"
        value="ws://localhost:8000/connection/websocket"
      />
      <button onclick="connect()">è¿æ¥</button>
      <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
    </div>

    <div>
      <h3>é¢‘é“è®¢é˜…</h3>
      <label>é¢‘é“åç§°: </label>
      <input type="text" id="channelName" value="public:chat" />
      <button onclick="subscribe()">è®¢é˜…</button>
      <button onclick="unsubscribe()">å–æ¶ˆè®¢é˜…</button>
    </div>

    <div>
      <h3>å‘é€æ¶ˆæ¯</h3>
      <label>æ¶ˆæ¯å†…å®¹: </label>
      <input type="text" id="messageText" value="Hello from client!" />
      <button onclick="publishMessage()">å‘é€æ¶ˆæ¯</button>
    </div>

    <div>
      <h3>è¿æ¥ä¿¡æ¯</h3>
      <button onclick="getInfo()">è·å–è¿æ¥ä¿¡æ¯</button>
      <button onclick="getPresence()">è·å–åœ¨çº¿ç”¨æˆ·</button>
      <button onclick="getHistory()">è·å–å†å²æ¶ˆæ¯</button>
    </div>

    <div>
      <h3>æ¶ˆæ¯æ—¥å¿—</h3>
      <div id="messages"></div>
      <button onclick="clearMessages()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
      let centrifuge = null;
      let subscription = null;
      let currentChannel = null;

      function log(message, type = "info") {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        messageDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function updateStatus(isConnected) {
        const statusDiv = document.getElementById("status");
        if (isConnected) {
          statusDiv.textContent = "å·²è¿æ¥åˆ°é›†ç¾¤";
          statusDiv.className = "status connected";
        } else {
          statusDiv.textContent = "æœªè¿æ¥";
          statusDiv.className = "status disconnected";
        }
      }
      var jwt = require("jsonwebtoken");
      function generateToken() {
        const header = { alg: "HS256", typ: "JWT" };
        const payload = {
          sub: "user123",
          exp: Math.floor(Date.now() / 1000) + 60 * 60,
          iat: Math.floor(Date.now() / 1000),
        };
        const secret = "my_secret";

        return KJUR.jws.JWS.sign(
          "HS256",
          JSON.stringify(header),
          JSON.stringify(payload),
          secret
        );
      }
      function connect() {
        const serverUrl = document.getElementById("serverUrl").value;

        if (centrifuge) {
          disconnect();
        }

        centrifuge = new Centrifuge(serverUrl, {
          // é›†ç¾¤æ¨¡å¼ä¸‹çš„é…ç½®
          debug: true,
          token: generateToken(),
        });

        centrifuge.on("connecting", function (ctx) {
          log(`æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨... (${ctx.code}, ${ctx.reason})`);
        });

        centrifuge.on("connected", function (ctx) {
          log(
            `âœ… å·²è¿æ¥åˆ°é›†ç¾¤! å®¢æˆ·ç«¯ID: ${ctx.client}, ä¼ è¾“æ–¹å¼: ${ctx.transport}`
          );
          updateStatus(true);
        });

        centrifuge.on("disconnected", function (ctx) {
          log(`âŒ ä¸é›†ç¾¤æ–­å¼€è¿æ¥ (${ctx.code}, ${ctx.reason})`);
          updateStatus(false);
        });

        centrifuge.on("error", function (ctx) {
          log(`âŒ è¿æ¥é”™è¯¯: ${ctx.message}`, "error");
        });

        centrifuge.connect();
      }

      function disconnect() {
        if (centrifuge) {
          centrifuge.disconnect();
          centrifuge = null;
          updateStatus(false);
          log("ä¸»åŠ¨æ–­å¼€è¿æ¥");
        }
      }

      function subscribe() {
        if (!centrifuge) {
          log("âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨", "error");
          return;
        }

        const channelName = document.getElementById("channelName").value;

        if (subscription) {
          unsubscribe();
        }

        subscription = centrifuge.newSubscription(channelName);
        currentChannel = channelName;

        subscription.on("publication", function (ctx) {
          log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ [${channelName}]: ${JSON.stringify(ctx.data)}`);
        });

        subscription.on("subscribing", function (ctx) {
          log(`æ­£åœ¨è®¢é˜…é¢‘é“ ${channelName}...`);
        });

        subscription.on("subscribed", function (ctx) {
          log(`âœ… å·²è®¢é˜…é¢‘é“ ${channelName}`);
        });

        subscription.on("unsubscribed", function (ctx) {
          log(`å·²å–æ¶ˆè®¢é˜…é¢‘é“ ${channelName} (${ctx.code}, ${ctx.reason})`);
        });

        subscription.on("error", function (ctx) {
          log(`âŒ è®¢é˜…é”™è¯¯: ${ctx.message}`, "error");
        });

        subscription.subscribe();
      }

      function unsubscribe() {
        if (subscription) {
          subscription.unsubscribe();
          subscription = null;
          currentChannel = null;
          log("å·²å–æ¶ˆè®¢é˜…");
        }
      }

      function publishMessage() {
        if (!centrifuge) {
          log("âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨", "error");
          return;
        }

        const channelName = document.getElementById("channelName").value;
        const messageText = document.getElementById("messageText").value;

        const data = {
          text: messageText,
          user: `client_${Math.random().toString(36).substr(2, 9)}`,
          timestamp: new Date().toISOString(),
        };

        centrifuge
          .publish(channelName, data)
          .then(function () {
            log(`âœ… æ¶ˆæ¯å‘é€æˆåŠŸåˆ°é¢‘é“ ${channelName}`);
            document.getElementById("messageText").value = "";
          })
          .catch(function (err) {
            log(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${err.message}`, "error");
          });
      }

      function getInfo() {
        if (!centrifuge) {
          log("âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨", "error");
          return;
        }

        log(`è¿æ¥çŠ¶æ€: ${centrifuge.state}`);
        log(`è¿æ¥URL: ${centrifuge._config.url}`);
        log(
          `ä¼ è¾“æ–¹å¼: ${
            centrifuge._transport ? centrifuge._transport.name() : "æœªçŸ¥"
          }`
        );
      }

      function getPresence() {
        if (!subscription || !currentChannel) {
          log("âŒ è¯·å…ˆè®¢é˜…é¢‘é“", "error");
          return;
        }

        subscription
          .presence()
          .then(function (result) {
            log(
              `ğŸ“‹ é¢‘é“ ${currentChannel} åœ¨çº¿ç”¨æˆ·æ•°: ${
                Object.keys(result.presence).length
              }`
            );
            Object.keys(result.presence).forEach((clientId) => {
              const client = result.presence[clientId];
              log(
                `ğŸ‘¤ ç”¨æˆ·: ${clientId}, è¿æ¥æ—¶é—´: ${new Date(
                  client.connectedAt * 1000
                ).toLocaleTimeString()}`
              );
            });
          })
          .catch(function (err) {
            log(`âŒ è·å–åœ¨çº¿ç”¨æˆ·å¤±è´¥: ${err.message}`, "error");
          });
      }

      function getHistory() {
        if (!subscription || !currentChannel) {
          log("âŒ è¯·å…ˆè®¢é˜…é¢‘é“", "error");
          return;
        }

        subscription
          .history()
          .then(function (result) {
            log(
              `ğŸ“š é¢‘é“ ${currentChannel} å†å²æ¶ˆæ¯æ•°: ${result.publications.length}`
            );
            result.publications.forEach((pub, index) => {
              log(`ğŸ“œ å†å²æ¶ˆæ¯ ${index + 1}: ${JSON.stringify(pub.data)}`);
            });
          })
          .catch(function (err) {
            log(`âŒ è·å–å†å²æ¶ˆæ¯å¤±è´¥: ${err.message}`, "error");
          });
      }

      function clearMessages() {
        document.getElementById("messages").innerHTML = "";
      }

      // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
      window.onload = function () {
        log("ğŸš€ Centrifugo é›†ç¾¤æµ‹è¯•å®¢æˆ·ç«¯å·²å°±ç»ª");
        log('ğŸ’¡ æç¤º: å…ˆç‚¹å‡»"è¿æ¥"æŒ‰é’®è¿æ¥åˆ°é›†ç¾¤ï¼Œç„¶åè®¢é˜…é¢‘é“è¿›è¡Œæµ‹è¯•');
      };

      // é¡µé¢å…³é—­æ—¶æ¸…ç†è¿æ¥
      window.onbeforeunload = function () {
        if (centrifuge) {
          centrifuge.disconnect();
        }
      };
    </script>
  </body>
</html>
