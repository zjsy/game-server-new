version: '3.8'

services:
  # NATS - 轻量级消息代理 (最新版本)
  nats:
    image: nats:2.10-alpine
    container_name: centrifugo-nats
    restart: always
    ports:
      - "4222:4222"  # 客户端连接
      - "6222:6222"  # 路由端口
      - "8222:8222"  # HTTP 监控
    command: [
      "--js",           # 启用 JetStream
      "--sd", "/data",  # 数据存储目录
      "--http_port", "8222",  # HTTP 监控端口
      "--max_payload", "64MB",  # 增大最大载荷
      "--max_connections", "1000"  # 最大连接数
    ]
    volumes:
      - nats_data:/data
    networks:
      - centrifugo_net
    healthcheck:
      test: ["CMD", "nats", "--server=nats://localhost:4222", "server", "check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Centrifugo 节点 1 (v6 统一端口)
  centrifugo-1:
    image: centrifugo/centrifugo:v6
    container_name: centrifugo-1
    restart: always
    ports:
      - "8001:8000"          # 统一端口 (管理界面、WebSocket、API)
    command: ["centrifugo", "--config", "/centrifugo/config.json"]
    volumes:
      - ./config-nats.json:/centrifugo/config.json:ro
    depends_on:
      nats:
        condition: service_healthy
    networks:
      - centrifugo_net
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # Centrifugo 节点 2 (v6 统一端口)
  centrifugo-2:
    image: centrifugo/centrifugo:v6
    container_name: centrifugo-2
    restart: always
    ports:
      - "8002:8000"          # 统一端口 (管理界面、WebSocket、API)
    command: ["centrifugo", "--config", "/centrifugo/config.json"]
    volumes:
      - ./config-nats.json:/centrifugo/config.json:ro
    depends_on:
      nats:
        condition: service_healthy
    networks:
      - centrifugo_net
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # Centrifugo 节点 3 (v6 统一端口)
  centrifugo-3:
    image: centrifugo/centrifugo:v6
    container_name: centrifugo-3
    restart: always
    ports:
      - "8003:8000"          # 统一端口 (管理界面、WebSocket、API)
    command: ["centrifugo", "--config", "/centrifugo/config.json"]
    volumes:
      - ./config-nats.json:/centrifugo/config.json:ro
    depends_on:
      nats:
        condition: service_healthy
    networks:
      - centrifugo_net
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # Nginx 负载均衡器 (v6 统一端口)
  nginx:
    image: nginx:alpine
    container_name: centrifugo-nginx
    restart: always
    ports:
      - "8000:80"            # 统一对外端口 (WebSocket、管理界面、API)
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - centrifugo-1
      - centrifugo-2
      - centrifugo-3
    networks:
      - centrifugo_net

  # NATS 监控和管理 (可选)
  nats-box:
    image: natsio/nats-box:latest
    container_name: nats-box
    restart: "no"  # 按需启动的工具容器
    depends_on:
      - nats
    networks:
      - centrifugo_net
    profiles:
      - tools
  
  # NATS 监控导出器
  nats-exporter:
    image: natsio/prometheus-nats-exporter:latest
    container_name: nats-exporter
    restart: always
    ports:
      - "7777:7777"
    command: [
      "-varz", "-connz", "-routez", "-subz", "-jsz",
      "http://nats:8222"
    ]
    depends_on:
      - nats
    networks:
      - centrifugo_net
    profiles:
      - monitoring

volumes:
  nats_data:

networks:
  centrifugo_net:
    driver: bridge
