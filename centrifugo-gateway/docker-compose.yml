version: '3.8'

services:
  # Redis - 用于 Centrifugo 集群消息代理
  centrifugo-redis:
    image: redis:7-alpine
    container_name: centrifugo-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - centrifugo_net
    command: redis-server --appendonly yes

  # Centrifugo 节点 1
  centrifugo-1:
    image: centrifugo/centrifugo:v6
    container_name: centrifugo-1
    restart: always
    ports:
      - "8001:8000"          # 客户端连接端口
    # command: ["centrifugo", "--config", "/centrifugo/config.json"]
    volumes:
      - ./config.json:/centrifugo/config.json:ro
    depends_on:
      - centrifugo-redis
    networks:
      - centrifugo_net
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # Centrifugo 节点 2
  centrifugo-2:
    image: centrifugo/centrifugo:v6
    container_name: centrifugo-2
    restart: always
    ports:
      - "8002:8000"          # 客户端连接端口
    command: ["centrifugo", "--config", "/centrifugo/config.json"]
    volumes:
      - ./config.json:/centrifugo/config.json:ro
    depends_on:
      - centrifugo-redis
    networks:
      - centrifugo_net
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # Centrifugo 节点 3
  centrifugo-3:
    image: centrifugo/centrifugo:v6
    container_name: centrifugo-3
    restart: always
    ports:
      - "8003:8000"          # 客户端连接端口
    command: ["centrifugo", "--config", "/centrifugo/config.json"]
    volumes:
      - ./config.json:/centrifugo/config.json:ro
    depends_on:
      - centrifugo-redis
    networks:
      - centrifugo_net
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

  # Nginx 负载均衡器
  centrifugo-nginx:
    image: nginx:alpine
    container_name: centrifugo-nginx
    restart: always
    ports:
      - "8000:80"            # 对外统一端口
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - centrifugo-1
      - centrifugo-2
      - centrifugo-3
    networks:
      - centrifugo_net

volumes:
  redis_data:

networks:
  centrifugo_net:
    name: centrifugo-net
    driver: bridge
