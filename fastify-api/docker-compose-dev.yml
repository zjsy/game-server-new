# Dev Container Docker Compose
version: '3.8'

services:
  dealer-api-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: dealer-api-devcontainer
    volumes:
      - .:/app  # 挂载源码目录（移除 cached 选项以支持文件监听）
      - dealer_node_modules:/app/node_modules  # 保护 node_modules 不被覆盖
      - ./logs:/app/logs
      # Git 配置挂载
      - ~/.gitconfig:/home/fastify/.gitconfig:ro
      - ~/.ssh:/home/fastify/.ssh:ro
    # env_file:
    #   - .env
    environment:
      - HOST=0.0.0.0
      - PORT=3000
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
    ports:
      - "3000:3000"
      - "9229:9229"  # Node.js 调试端口
    networks:
      - game_server_net
      - centrifugo_net
    depends_on:
      # - mysql
      - redis-dev
    # 保持容器运行
    command: sleep infinity
    # 开发容器需要的特权
    privileged: true
    cap_add:
      - SYS_PTRACE

  # Redis 开发缓存
  redis-dev:
    image: redis:7-alpine
    container_name: dealer-redis-devcontainer
    restart: unless-stopped
    ports:
      - "6381:6379"
    volumes:
      - redis_dev_data:/data
    networks:
      - game_server_net
    command: redis-server --appendonly yes

volumes:
  dealer_node_modules:
  mysql_dev_data:
  redis_dev_data:

networks:
  game_server_net:
    driver: bridge
    external: true
  centrifugo_net:
    external: true
