# Dev Container è¿ç§»å®Œæˆ

## ğŸš€ Dev Container é…ç½®å·²å®Œæˆ

### ğŸ“ æ–°å¢çš„æ–‡ä»¶ç»“æ„
```
fastify-api/
â”œâ”€â”€ .devcontainer/
â”‚   â”œâ”€â”€ devcontainer.json      # ä¸»é…ç½®æ–‡ä»¶
â””â”€â”€ .vscode/
    â”œâ”€â”€ launch.json           # è°ƒè¯•é…ç½®
    â””â”€â”€ tasks.json           # ä»»åŠ¡é…ç½®
â”œâ”€â”€ docker-compose-dev.yml     # Dev Container ä¸“ç”¨ç¼–æ’
â”œâ”€â”€ Dockerfile.dev            # Dev Container ä¸“ç”¨é•œåƒ
```

## ğŸ¯ å¦‚ä½•ä½¿ç”¨ Dev Container

### 1. **å‰ç½®è¦æ±‚**
- âœ… VS Code å·²å®‰è£…
- âœ… Docker Desktop å·²å®‰è£…å¹¶è¿è¡Œ
- âœ… VS Code æ‰©å±•ï¼š`Dev Containers` å·²å®‰è£…

### 2. **æ‰“å¼€ Dev Container**

#### æ–¹æ³•ä¸€ï¼šå‘½ä»¤é¢æ¿
1. æŒ‰ `Ctrl+Shift+P` (Windows) æˆ– `Cmd+Shift+P` (Mac)
2. è¾“å…¥ `Dev Containers: Open Folder in Container`
3. é€‰æ‹© `fastify-api` æ–‡ä»¶å¤¹

#### æ–¹æ³•äºŒï¼šå¼¹çª—æç¤º
1. ç”¨ VS Code æ‰“å¼€ `fastify-api` æ–‡ä»¶å¤¹
2. å³ä¸‹è§’ä¼šå‡ºç° "Reopen in Container" æç¤º
3. ç‚¹å‡» "Reopen in Container"

#### æ–¹æ³•ä¸‰ï¼šçŠ¶æ€æ 
1. ç‚¹å‡» VS Code å·¦ä¸‹è§’çš„ç»¿è‰²æŒ‰é’®
2. é€‰æ‹© "Reopen in Container"

### 3. **é¦–æ¬¡å¯åŠ¨æµç¨‹**
```bash
1. VS Code å¼€å§‹æ„å»º Dev Container
   â”œâ”€â”€ æ„å»ºå¼€å‘å®¹å™¨é•œåƒ
   â”œâ”€â”€ å¯åŠ¨æ‰€æœ‰æœåŠ¡ (API, MySQL, Redis, Adminer)
   â””â”€â”€ å®‰è£… VS Code æ‰©å±•

2. å®¹å™¨å¯åŠ¨å®Œæˆå
   â”œâ”€â”€ è‡ªåŠ¨æ‰§è¡Œ npm install
   â”œâ”€â”€ æŒ‚è½½æºç åˆ°å®¹å™¨å†…
   â””â”€â”€ é…ç½®è°ƒè¯•ç¯å¢ƒ

3. å¼€å‘ç¯å¢ƒå°±ç»ª âœ…
```

## ğŸ”§ å¼€å‘å·¥ä½œæµ

### **å¯åŠ¨åº”ç”¨**
```bash
# åœ¨ VS Code ç»ˆç«¯ä¸­ (å®¹å™¨å†…)
npm run dev
```

### **è°ƒè¯•åº”ç”¨**
1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š`npm run dev`
2. æŒ‰ `F5` æˆ–ç‚¹å‡» "Run and Debug"
3. é€‰æ‹© "Debug Fastify App"
4. åœ¨ä»£ç ä¸­è®¾ç½®æ–­ç‚¹å³å¯è°ƒè¯•

### **æ•°æ®åº“ç®¡ç†**
- **Adminer**: http://localhost:8080
- **ç›´è¿ MySQL**: `localhost:3306`
- **ç›´è¿ Redis**: `localhost:6381`

### **å¯ç”¨ç«¯å£**
| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| Fastify API | 3000 | ä¸»åº”ç”¨ç«¯å£ |
| Node.js Debug | 9229 | è°ƒè¯•ç«¯å£ |
| MySQL | 3306 | æ•°æ®åº“ |
| Redis | 6381 | ç¼“å­˜ |
| Adminer | 8080 | æ•°æ®åº“ç®¡ç† |

## âœ¨ Dev Container çš„ä¼˜åŠ¿

### **vs. æ™®é€š Docker å¼€å‘**
| ç‰¹æ€§ | æ™®é€š Docker | Dev Container |
|------|-------------|---------------|
| VS Code é›†æˆ | æ‰‹åŠ¨é…ç½® | âœ… å¼€ç®±å³ç”¨ |
| è°ƒè¯•ä½“éªŒ | éœ€è¦é…ç½®ç«¯å£è½¬å‘ | âœ… è‡ªåŠ¨é…ç½® |
| æ‰©å±•ç®¡ç† | æœ¬åœ°å®‰è£… | âœ… å®¹å™¨å†…è‡ªåŠ¨å®‰è£… |
| ç»ˆç«¯ç¯å¢ƒ | å®¿ä¸»æœº | âœ… å®¹å™¨å†… |
| Git é›†æˆ | æœ¬åœ° Git | âœ… è‡ªåŠ¨æŒ‚è½½é…ç½® |
| è®¾ç½®åŒæ­¥ | æ‰‹åŠ¨ | âœ… è‡ªåŠ¨åº”ç”¨ |

### **å›¢é˜Ÿåä½œä¼˜åŠ¿**
- âœ… **ç¯å¢ƒä¸€è‡´æ€§**: æ‰€æœ‰å›¢é˜Ÿæˆå‘˜ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å¼€å‘ç¯å¢ƒ
- âœ… **é›¶é…ç½®**: æ–°æˆå‘˜åªéœ€æ‰“å¼€æ–‡ä»¶å¤¹å³å¯å¼€å§‹å¼€å‘
- âœ… **å·¥å…·ç»Ÿä¸€**: è‡ªåŠ¨å®‰è£…å’Œé…ç½®æ‰€éœ€çš„ VS Code æ‰©å±•
- âœ… **ä¾èµ–éš”ç¦»**: ä¸ä¼šæ±¡æŸ“æœ¬åœ°ç¯å¢ƒ

## ğŸ› ï¸ å¸¸ç”¨æ“ä½œ

### **é‡å»ºå®¹å™¨**
```bash
# æ–¹æ³•ä¸€ï¼šå‘½ä»¤é¢æ¿
Ctrl+Shift+P â†’ Dev Containers: Rebuild Container

# æ–¹æ³•äºŒï¼šå¦‚æœé‡åˆ°é—®é¢˜
docker-compose -f .devcontainer/docker-compose.yml down -v
```

### **æŸ¥çœ‹æ—¥å¿—**
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose -f .devcontainer/docker-compose.yml ps

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose -f .devcontainer/docker-compose.yml logs mysql-dev
```

### **æ•°æ®åº“æ“ä½œ**
```bash
# è¿æ¥ MySQL
docker-compose -f .devcontainer/docker-compose.yml exec mysql-dev mysql -u mysql -pdev123 gameserver_dev

# è¿æ¥ Redis
docker-compose -f .devcontainer/docker-compose.yml exec redis-dev redis-cli
```

## ğŸ¯ VS Code é›†æˆåŠŸèƒ½

### **è‡ªåŠ¨å®‰è£…çš„æ‰©å±•**
- ğŸ¨ **Biome**: ä»£ç æ ¼å¼åŒ–å’Œ Lint
- ğŸ“ **TypeScript**: ç±»å‹æ£€æŸ¥
- ğŸ” **Error Lens**: è¡Œå†…é”™è¯¯æ˜¾ç¤º
- ğŸ“ **Path Intellisense**: è·¯å¾„è‡ªåŠ¨è¡¥å…¨
- ğŸ³ **Docker**: Docker æ”¯æŒ

### **é¢„é…ç½®çš„è°ƒè¯•**
- ğŸ› **åº”ç”¨è°ƒè¯•**: é™„åŠ åˆ°è¿è¡Œä¸­çš„åº”ç”¨
- ğŸ§ª **æµ‹è¯•è°ƒè¯•**: è¿è¡Œå’Œè°ƒè¯•æµ‹è¯•

### **é¢„é…ç½®çš„ä»»åŠ¡**
- âš¡ **dev**: å¯åŠ¨å¼€å‘æœåŠ¡å™¨
- ğŸ”¨ **build**: æ„å»ºåº”ç”¨
- ğŸ§ª **test**: è¿è¡Œæµ‹è¯•
- ğŸ¨ **lint**: ä»£ç æ£€æŸ¥

## ğŸ”„ è¿ç§»å¯¹æ¯”

### **è¿ç§»å‰ vs è¿ç§»å**
| æ“ä½œ | è¿ç§»å‰ | è¿ç§»å |
|------|--------|--------|
| å¯åŠ¨å¼€å‘ç¯å¢ƒ | `docker-compose up` + æœ¬åœ° VS Code | ç‚¹å‡» "Reopen in Container" |
| è°ƒè¯•åº”ç”¨ | æ‰‹åŠ¨é…ç½®ç«¯å£è½¬å‘ | æŒ‰ F5 |
| å®‰è£…æ‰©å±• | æ‰‹åŠ¨å®‰è£…åˆ°æœ¬åœ° | è‡ªåŠ¨å®‰è£…åˆ°å®¹å™¨ |
| å›¢é˜Ÿç¯å¢ƒä¸€è‡´æ€§ | ä¾èµ–æœ¬åœ°é…ç½® | å®Œå…¨ä¸€è‡´ |
| Git æ“ä½œ | æœ¬åœ° Git | å®¹å™¨å†… Git (è‡ªåŠ¨é…ç½®) |

## ğŸš¨ æ•…éšœæ’é™¤

### **å¸¸è§é—®é¢˜**

#### 1. **å®¹å™¨æ„å»ºå¤±è´¥**
```bash
# æ¸…ç†å¹¶é‡å»º
docker system prune -a
# ç„¶åé‡æ–°æ‰“å¼€ Dev Container
```

#### 2. **ç«¯å£å†²çª**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -ano | findstr :3000
# å…³é—­å ç”¨ç«¯å£çš„ç¨‹åº
```

#### 3. **æ–‡ä»¶æƒé™é—®é¢˜**
```bash
# åœ¨å®¹å™¨å†…ä¿®å¤æƒé™
sudo chown -R fastify:fastify /app
```

#### 4. **æ‰©å±•æœªè‡ªåŠ¨å®‰è£…**
```bash
# æ‰‹åŠ¨é‡è½½æ‰©å±•
Ctrl+Shift+P â†’ Developer: Reload Window
```

## ğŸ‰ æ€»ç»“

âœ… **Dev Container è¿ç§»å®Œæˆï¼**

**ä¸»è¦æ”¹è¿›ï¼š**
- ğŸš€ **å¼€å‘ä½“éªŒ**: ä»é…ç½®ç¹ç â†’ å¼€ç®±å³ç”¨
- ğŸ”§ **è°ƒè¯•ä½“éªŒ**: ä»æ‰‹åŠ¨é…ç½® â†’ è‡ªåŠ¨åŒ–è°ƒè¯•
- ğŸ‘¥ **å›¢é˜Ÿåä½œ**: ä»ç¯å¢ƒä¸ä¸€è‡´ â†’ å®Œå…¨ç»Ÿä¸€
- ğŸ¯ **å·¥å…·é›†æˆ**: ä»æ‰‹åŠ¨ç®¡ç† â†’ è‡ªåŠ¨åŒ–ç®¡ç†

**ä¸‹æ¬¡å¼€å‘æ—¶ï¼Œåªéœ€ï¼š**
1. æ‰“å¼€ VS Code
2. é€‰æ‹© "Reopen in Container"
3. ç­‰å¾…ç¯å¢ƒå‡†å¤‡å®Œæˆ
4. å¼€å§‹ç¼–ç ï¼ ğŸ‰


## å…³äºçƒ­æ›´æ–°
Fastify CLI ä¾èµ– chokidar ç›‘å¬æ–‡ä»¶å˜æ›´ã€‚

åœ¨ Docker bind mountï¼ˆå°¤å…¶æ˜¯ Windows / macOS â†’ Linux å®¹å™¨ï¼‰ ä¸­ï¼š

inotify ä¸ä¼šè§¦å‘

chokidar é»˜è®¤ç›‘å¬ä¸åˆ°å˜åŒ–

æ‰€ä»¥ Fastify CLI æ ¹æœ¬ä¸é‡å¯æœåŠ¡

åŠ å…¥ï¼š

CHOKIDAR_USEPOLLING=true


ä¼šè®© chokidar è¿›å…¥â€œè½®è¯¢æ¨¡å¼â€ï¼š

ä¸ä¾èµ– inotify

æ¯éš”å‡ ç™¾ ms æ‰«æä¸€æ¬¡æ–‡ä»¶æ˜¯å¦æ”¹å˜

bind mount 100% èƒ½æ£€æµ‹åˆ°å˜åŒ–

ä¸ Fastify CLI è‡ªå¸¦çš„ --watch-options={usePolling:true} ä¸åŒçš„æ˜¯ï¼š

ä½ å¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡å¼ºåˆ¶ chokidar æœ¬èº«å¯ç”¨ pollingï¼ŒCLI å±‚è®¾ç½®ä¸èµ·ä½œç”¨ã€‚

æ‰€ä»¥è¿™ä¸ªç¯å¢ƒå˜é‡æ‰æ˜¯å†³å®šæ€§å› ç´ ã€‚

ç›®å‰åˆå‘ç”Ÿä¸€ä¸ªæ–°çš„é—®é¢˜,CHOKIDAR_USEPOLLING=trueæ—¶å€™:
```
"dev:start": "fastify start -w --watch-files='dist/**/*.js' -l info -P -p 8100 dist/app.js",
```
ä¼šé€ æˆæ— è®ºä¿®æ”¹ä»€ä¹ˆæ–‡ä»¶éƒ½ä¼šé€ æˆçƒ­æ›´æ–°
```
"dev:start": "fastify start -w --watch-dir=dist --ignore-watch='.*' -l info -P dist/app.js"
```
åˆä¼šé€ æˆæ‰€æœ‰çš„ä¿®æ”¹éƒ½ä¸ä¼šè§¦å‘çƒ­æ›´

æ‰€ä»¥æœ€ç»ˆçš„æ–¹æ¡ˆæ˜¯å¹²è„†ä½¿ç”¨tsx,æ›´åˆé€‚

## å…³äºforwardPorts å’Œ portsAttributes
devcontainer.json çš„ forwardPorts å’Œ portsAttributes åªæ˜¯å‘Šè¯‰ VS Codeï¼š
â€œå®¹å™¨é‡ŒæŸä¸ªç«¯å£éœ€è¦è¢«è½¬å‘åˆ°å®¿ä¸»æœºï¼Œæ–¹ä¾¿ä½ åœ¨æœ¬åœ°è®¿é—®ã€‚â€

å®ƒä»¬ä¸ä¼šä¹Ÿä¸èƒ½æ”¹å˜å®¹å™¨é‡ŒæœåŠ¡çš„ åŸå§‹ç›‘å¬ç«¯å£ã€‚

ğŸ”¹ åŸç†æ‹†è§£
- æœåŠ¡ç›‘å¬ç«¯å£ï¼šç”±ä½ åœ¨åº”ç”¨æˆ– Docker Compose ä¸­é…ç½®å†³å®šï¼Œæ¯”å¦‚ Redis é»˜è®¤ç›‘å¬ 6379ï¼ŒFastify é…ç½®ç›‘å¬ 3000ã€‚
- Docker æ˜ å°„ï¼šports: "6381:6379" â†’ å®¿ä¸»æœº 6381 â†’ å®¹å™¨ 6379ã€‚
- Dev Container è½¬å‘ï¼šforwardPorts: [3000, 9229, 6381] â†’ å®¹å™¨ç«¯å£ç›´æ¥è½¬å‘åˆ°å®¿ä¸»æœºåŒå·ç«¯å£ã€‚
ğŸ‘‰ æ³¨æ„ï¼šVS Code è½¬å‘åªèƒ½åŸºäºå®¹å™¨é‡Œå·²æœ‰çš„ç«¯å£ï¼Œå®ƒä¸ä¼šå¸®ä½ â€œæ”¹â€æœåŠ¡ç›‘å¬ç«¯å£ã€‚

âš¡ ä¸¾ä¾‹
- å¦‚æœ Redis åœ¨å®¹å™¨é‡Œç›‘å¬ 6379ï¼Œä½ åœ¨ forwardPorts å†™ 6381ï¼ŒVS Code ä¼šå°è¯•è½¬å‘å®¹å™¨çš„ 6381ï¼Œä½†å®¹å™¨é‡Œå¹¶æ²¡æœ‰è¿™ä¸ªç«¯å£ â†’ è½¬å‘å¤±è´¥ã€‚
- å¦‚æœä½ æƒ³è®©å®¿ä¸»æœºè®¿é—® localhost:6381ï¼Œå¿…é¡»åœ¨ Docker Compose é‡Œåš 6381:6379 çš„æ˜ å°„ã€‚
- å¦‚æœä½ åªå†™ forwardPorts: [6379]ï¼Œé‚£ä¹ˆ VS Code ä¼šæŠŠå®¹å™¨çš„ 6379 è½¬å‘åˆ°å®¿ä¸»æœºçš„ 6379ï¼Œä½†ä¸ä¼šè‡ªåŠ¨å˜æˆ 6381ã€‚

âœ… æ€»ç»“
- forwardPorts â‰  æ”¹ç«¯å£å·
- å®ƒåªæ˜¯è½¬å‘å®¹å™¨é‡Œå·²æœ‰çš„ç«¯å£åˆ°å®¿ä¸»æœºåŒå·ç«¯å£ã€‚
- è¦æ”¹å˜å®¿ä¸»æœºè®¿é—®ç«¯å£å·ï¼Œå¿…é¡»ç”¨ Docker Compose çš„ ports æ˜ å°„ã€‚

## å…³äºcontainerEnv
  "containerEnv": {
    "HOST": "0.0.0.0",
    "PORT": "3000"
  },
  devcontainer.jsonçš„envé…ç½®ä¼šè¦†ç›–docker-composeæ–‡ä»¶ä¸­çš„envé…ç½®,æ‰€ä»¥éœ€è¦å¤šä¸ªæ–‡ä»¶ç¡®è®¤

