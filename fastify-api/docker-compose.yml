services:
  dealer-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: fggame/dealer-api:latest
    container_name: dealer-api
    restart: always
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    networks:
      - game_server_net
      - centrifugo_net
    depends_on:
      - dealer-redis
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:${PORT:-3000}/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
        # 使用 Docker 日志驱动来优化日志管理
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis 缓存（可选）
  dealer-redis:
    image: redis:7-alpine
    container_name: dealer-redis
    restart: always
    ports:
      - "6381:6379"  # 使用不同端口避免与 Centrifugo Redis 冲突
    volumes:
      - redis_data:/data
    networks:
      - game_server_net
    command: redis-server --appendonly yes --requirepass "$BULLMQ_REDIS_PASSWORD"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$BULLMQ_REDIS_PASSWORD", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Nginx 反向代理（可选）
#   nginx:
#     image: nginx:alpine
#     container_name: dealer-nginx
#     restart: always
#     ports:
#       - "8081:80"
#       - "44301:443"
#     volumes:
#       - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
#       - ./nginx/ssl:/etc/nginx/ssl:ro  # SSL 证书目录
#     depends_on:
#       - dealer-api
#     networks:
#       - game_server_net
#     profiles:
#       - production

volumes:
  redis_data:

networks:
  game_server_net:
    external: true
  centrifugo_net:
    external: true
